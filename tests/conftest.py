from typing import Any, Dict

import numpy as np
import pytest

from landingai.common import SegmentationPrediction


@pytest.fixture
def seg_mask_validator():
    def assert_seg_mask(pred: SegmentationPrediction, expected: Dict[str, Any]):
        assert pred.label_name == expected["label_name"]
        assert pred.label_index == expected["label_index"]
        np.testing.assert_almost_equal(pred.score, expected["score"], decimal=3, err_msg='SEG score mismatch')
        assert pred.num_predicted_pixels == expected["num_predicted_pixels"]
        assert pred.percentage_predicted_pixels == expected["percentage_predicted_pixels"]
        assert pred.decoded_boolean_mask.shape == expected["mask_shape"]
        assert np.unique(pred.decoded_boolean_mask).tolist() == [0, 1]
        assert np.unique(pred.decoded_index_mask).tolist() == [0, pred.label_index]
        if "encoded_mask" in expected:
            assert pred.encoded_mask == expected["encoded_mask"]
    return assert_seg_mask


@pytest.fixture
def expected_seg_prediction():
    return {
        "label_name": "screw",
        "label_index": 1,
        "score": 0.99487104554061,
        "encoded_mask": "2134595Z28N2020Z28N2020Z28N2015Z36N2012Z36N2012Z36N2007Z43N2005Z43N2002Z49N1999Z49N1999Z49N1997Z51N1997Z51N1992Z58N1990Z58N1990Z58N1982Z66N1982Z66N1974Z74N1974Z74N1974Z74N1969Z79N1969Z79N1967Z81N1967Z81N1967Z81N1964Z84N1964Z84N1964Z84N1964Z87N1961Z87N1958Z90N1958Z90N1958Z90N1956Z92N1956Z92N1953Z95N1953Z95N1953Z95N1951Z97N1951Z97N1946Z99N1949Z99N1949Z99N1905Z10N28Z105N1905Z10N28Z105N1895Z31N12Z110N1895Z31N12Z110N1895Z31N12Z110N1892Z156N1892Z156N1892Z156N1890Z158N1890Z158N1890Z158N1890Z158N1890Z158N1890Z156N1892Z156N1889Z156N1892Z156N1892Z156N1892Z154N1894Z154N1894Z151N1897Z151N1897Z151N1897Z146N1902Z146N1902Z146N1902Z144N1904Z144N1904Z141N1907Z141N1907Z141N1907Z138N1910Z138N1910Z133N1915Z133N1915Z133N1915Z128N1920Z128N1920Z120N1928Z120N1928Z120N1928Z118N1930Z118N1933Z110N1938Z110N1938Z110N1938Z107N1941Z107N1941Z107N1941Z102N1946Z102N1948Z98N1950Z98N1950Z98N1950Z92N1956Z92N1959Z82N1966Z82N1966Z82N1968Z75N1973Z75N1976Z69N1979Z69N1979Z69N1979Z67N1981Z67N1984Z64N1984Z64N1984Z64N1984Z61N1987Z61N1987Z61N1987Z61N1987Z61N1989Z59N1989Z59N1989Z59N1992Z53N1995Z53N1997Z51N1997Z51N1997Z51N2000Z48N2000Z48N2005Z43N2005Z43N2005Z43N2007Z41N2007Z41N2007Z41N2010Z38N2010Z38N2013Z35N2013Z35N2013Z35N2018Z28N2020Z28N2030Z15N2033Z15N2033Z15N531789Z18N2030Z18N2030Z18N2020Z33N2015Z33N2010Z43N2005Z43N2005Z43N2000Z53N1995Z53N1995Z53N1992Z61N1987Z61N1984Z67N1981Z67N1981Z67N1976Z75N1973Z75N1966Z82N1966Z82N1966Z82N1955Z95N1953Z95N1948Z105N1943Z105N1943Z105N1938Z113N1935Z113N1930Z123N1925Z123N1925Z123N1920Z131N1917Z131N1917Z131N1912Z138N1910Z138N1905Z143N1905Z143N1905Z143N1902Z149N1899Z149N1894Z154N1894Z154N1894Z154N1891Z159N1889Z159N1887Z164N1884Z164N1884Z164N1879Z171N1877Z171N1877Z171N1872Z179N1869Z179N1861Z187N1861Z187N1861Z187N1856Z194N1854Z194N1849Z202N1846Z202N1846Z202N1841Z207N1841Z207N1838Z210N1838Z210N1838Z210N1833Z218N1830Z218N1825Z223N1825Z223N1825Z223N1822Z226N1822Z226N1822Z226N1817Z231N1817Z231N1815Z235N1813Z235N1813Z235N1805Z243N1805Z243N1797Z251N1797Z251N1797Z251N1792Z256N1792Z256N1784Z264N1784Z264N1784Z264N1779Z269N1779Z269N1777Z271N1777Z271N1777Z271N1772Z276N1772Z276N1772Z276N1769Z279N1769Z279N1764Z284N1764Z284N1764Z284N1754Z292N1756Z292N1738Z310N1738Z310N1738Z310N1725Z320N1728Z320N1718Z330N1718Z330N1718Z330N1713Z332N1716Z332N1716Z332N1713Z333N1715Z333N1710Z338N1710Z338N1710Z338N1707Z338N1710Z338N1672Z23N8Z343N1674Z23N8Z343N1674Z23N8Z343N1669Z376N1672Z376N1667Z381N1667Z381N1667Z381N1659Z387N1661Z387N1653Z392N1656Z392N1656Z392N1654Z392N1656Z392N1656Z392N1653Z392N1656Z392N1656Z389N1659Z389N1659Z389N1659Z387N1661Z387N1661Z384N1664Z384N1664Z384N1664Z382N1666Z382N1666Z377N1671Z377N1671Z377N1671Z371N1677Z371N1677Z366N1682Z366N1682Z366N1682Z364N1684Z364N1684Z364N1684Z359N1689Z359N1687Z358N1690Z358N1690Z358N1690Z356N1692Z356N1692Z353N1695Z353N1695Z353N1695Z348N1700Z348N1697Z346N1702Z346N1702Z346N1152Z20N530Z341N1157Z20N530Z341N1157Z20N530Z341N1154Z31N522Z336N1159Z31N522Z336N1157Z38N517Z333N1160Z38N517Z333N1160Z38N517Z333N1157Z44N514Z328N1162Z44N514Z328N1162Z51N507Z307N1183Z51N507Z307N1183Z51N507Z307N1181Z66N497Z299N1186Z66N497Z299N1186Z71N492Z294N1191Z71N492Z294N1191Z71N492Z294N1188Z79N489Z287N1193Z79N489Z287N1193Z84N489Z277N1198Z84N489Z277N1198Z84N489Z277N1195Z93N486Z269N1200Z93N486Z269N1200Z93N486Z269N1198Z97N489Z261N1201Z97N489Z261N1201Z97N492Z251N1208Z97N492Z251N1208Z97N492Z251N1208Z97N494Z238N1219Z97N494Z238N1219Z97N499Z226N1226Z97N499Z226N1226Z97N499Z226N1226Z97N499Z220N1232Z97N499Z220N1232Z97N502Z212N1237Z97N502Z212N1237Z97N502Z212N1239Z98N501Z205N1244Z98N501Z205N1244Z98N504Z200N1246Z98N504Z200N1246Z98N504Z200N1246Z100N502Z197N1249Z100N502Z197N1249Z100N502Z197N1252Z97N505Z189N1257Z97N505Z189N1262Z95N502Z184N1267Z95N502Z184N1267Z95N502Z184N1270Z94N500Z176N1278Z94N500Z176N1280Z92N500Z174N1282Z92N500Z174N1282Z92N500Z174N1287Z87N500Z169N1292Z87N500Z169N1295Z84N500Z166N1298Z84N500Z166N1298Z84N500Z166N1300Z82N500Z158N1308Z82N500Z158N1308Z82N500Z158N1311Z79N500Z153N1316Z79N500Z153N1316Z79N502Z146N1321Z79N502Z146N1321Z79N502Z146N1318Z82N502Z141N1323Z82N502Z141N1323Z80N504Z141N1323Z80N504Z141N1323Z80N504Z141N1323Z77N507Z138N1326Z77N507Z138N1324Z77N509Z136N1326Z77N509Z136N1326Z77N509Z136N1326Z74N515Z133N1326Z74N515Z133N1326Z74N515Z130N1329Z74N515Z130N1329Z74N515Z130N1329Z72N517Z130N1329Z72N517Z130N1329Z72N517Z130N1326Z75N519Z126N1328Z75N519Z126N1328Z75N522Z123N1328Z75N522Z123N1328Z75N522Z123N1326Z77N524Z121N1326Z77N524Z121N1323Z80N524Z121N1323Z80N524Z121N1323Z80N524Z121N1321Z82N527Z118N1321Z82N527Z118N1321Z82N527Z118N1321Z82N527Z118N1321Z82N527Z118N1318Z85N529Z116N1318Z85N529Z116N1318Z85N529Z116N1318Z85N529Z116N1318Z85N529Z116N1318Z82N535Z113N1318Z82N535Z113N1318Z82N535Z113N1318Z82N535Z110N1321Z82N535Z110N1321Z82N538Z107N1321Z82N538Z107N1321Z82N538Z107N1321Z79N543Z103N1323Z79N543Z103N1323Z77N548Z97N1326Z77N548Z97N1326Z77N548Z97N1324Z76N553Z95N1324Z76N553Z95N1324Z74N560Z87N1327Z74N560Z87N1327Z74N560Z87N1327Z71N566Z82N1329Z71N566Z82N1329Z71N566Z82N1329Z69N571Z79N1329Z69N571Z79N1329Z69N576Z71N1332Z69N576Z71N1332Z69N576Z71N1334Z67N578Z67N1336Z67N578Z67N1336Z64N584Z61N1339Z64N584Z61N1339Z64N584Z61N1339Z64N586Z54N1344Z64N586Z54N1344Z64N586Z49N1349Z64N586Z49N1349Z64N586Z49N1349Z62N591Z43N1352Z62N591Z43N1352Z62N593Z39N1354Z62N593Z39N1354Z62N593Z39N1354Z62N596Z33N1357Z62N596Z33N1357Z62N596Z33N1360Z56N604Z26N1362Z56N604Z26N1364Z51N625Z3N1369Z51N625Z3N1369Z51N625Z3N1372Z46N2002Z46N2007Z36N2012Z36N2012Z36N2014Z29N2019Z29N2025Z17N2031Z17N2031Z17N2033Z13N2035Z13N2038Z5N2043Z5N2043Z5N519175Z",
        "num_predicted_pixels": 94553,
        "percentage_predicted_pixels": 0.02254319190979004,
        "mask_shape": (2048, 2048),
    }
