import logging
from pathlib import Path
from typing import Any

import numpy as np
from PIL import Image

from landingai.common import SegmentationPrediction
from landingai.predict import Predictor
from landingai.visualize import overlay_predictions

_API_KEY = "v7b0hdyfj6271xy2o9lmiwkkcbdpvt1"
_API_SECRET = "ao6yjcju7q1e6u0udgwrgknhrx6m4n1o48z81jy6huc059gne047l4fq3u1cgq"
_EXPECTED_SEG_PRED = {
    "label_name": "screw",
    "label_index": 1,
    "score": 0.9943678986830876,
    "encoded_mask": "1778676Z5N2043Z5N2043Z5N2043Z5N2043Z5N2043Z5N2043Z5N2043Z5N2045Z3N2045Z3N2045Z3N335437Z23N2025Z23N2025Z23N2017Z33N2015Z33N2015Z33N2010Z41N2007Z41N2004Z46N2002Z46N2002Z46N2000Z51N1997Z51N1992Z56N1992Z56N1992Z56N1986Z62N1986Z62N1979Z69N1979Z69N1979Z69N1971Z79N1969Z79N1967Z81N1967Z81N1967Z81N1964Z84N1964Z84N1964Z84N1961Z87N1961Z87N1961Z87N1961Z87N1961Z87N1959Z89N1959Z89N1959Z89N1959Z89N1959Z89N1956Z92N1956Z92N1949Z99N1949Z99N1949Z99N1892Z18N31Z107N1892Z18N31Z107N1890Z158N1890Z158N1890Z158N1890Z158N1890Z158N1890Z158N1887Z161N1887Z161N1887Z159N1889Z159N1889Z159N1889Z159N1889Z159N1889Z156N1892Z156N1892Z156N1892Z154N1894Z154N1894Z151N1897Z151N1897Z151N1897Z149N1899Z149N1899Z149N1899Z144N1904Z144N1904Z141N1907Z141N1907Z141N1907Z138N1910Z138N1910Z133N1915Z133N1915Z133N1915Z128N1920Z128N1920Z123N1925Z123N1925Z123N1928Z115N1933Z115N1933Z110N1938Z110N1938Z110N1938Z107N1941Z107N1941Z107N1943Z103N1945Z103N1945Z100N1948Z100N1948Z100N1951Z89N1959Z89N1961Z80N1968Z80N1968Z80N1971Z72N1976Z72N1976Z69N1979Z69N1979Z69N1982Z64N1984Z64N1984Z61N1987Z61N1987Z61N1989Z59N1989Z59N1989Z59N1989Z56N1992Z56N1995Z53N1995Z53N1995Z53N1997Z51N1997Z51N2000Z48N2000Z48N2000Z48N2002Z46N2002Z46N2007Z41N2007Z41N2007Z41N2010Z38N2010Z38N2010Z38N2010Z38N2010Z38N2013Z35N2013Z35N2013Z35N2018Z28N2020Z28N2030Z15N2033Z15N2033Z15N542016Z28N2020Z28N2020Z28N2015Z41N2007Z41N2007Z41N1999Z54N1994Z54N1989Z64N1984Z64N1984Z64N1977Z76N1972Z76N1964Z87N1961Z87N1961Z87N1956Z95N1953Z95N1948Z105N1943Z105N1943Z105N1938Z115N1933Z115N1928Z122N1926Z122N1926Z122N1920Z131N1917Z131N1917Z131N1912Z139N1909Z139N1904Z146N1902Z146N1902Z146N1897Z154N1894Z154N1891Z157N1891Z157N1891Z157N1889Z161N1887Z161N1882Z166N1882Z166N1882Z166N1877Z174N1874Z174N1874Z174N1869Z181N1867Z181N1861Z190N1858Z190N1858Z190N1851Z197N1851Z197N1843Z207N1841Z207N1841Z207N1836Z215N1833Z215N1830Z218N1830Z218N1830Z218N1828Z220N1828Z220N1823Z225N1823Z225N1823Z225N1820Z228N1820Z228N1820Z228N1815Z236N1812Z236N1802Z246N1802Z246N1802Z246N1794Z254N1794Z254N1789Z259N1789Z259N1789Z259N1786Z262N1786Z262N1784Z264N1784Z264N1784Z264N1781Z267N1781Z267N1779Z269N1779Z269N1779Z269N1776Z272N1776Z272N1776Z272N1774Z274N1774Z274N1774Z271N1777Z271N1777Z271N1769Z279N1769Z279N1759Z289N1759Z289N1759Z289N1746Z299N1749Z299N1736Z310N1738Z310N1738Z310N1728Z320N1728Z320N1728Z320N1723Z322N1726Z322N1721Z325N1723Z325N1723Z325N1718Z327N1721Z327N1710Z336N1712Z336N1712Z336N1687Z358N1690Z358N1685Z361N1687Z361N1687Z361N1684Z358N1690Z358N1687Z359N1689Z359N1689Z359N1687Z358N1690Z358N1690Z358N1687Z361N1687Z361N1687Z359N1689Z359N1689Z359N1687Z361N1687Z361N1687Z358N1690Z358N1690Z358N1687Z359N1689Z359N1687Z355N1693Z355N1693Z355N1690Z356N1692Z356N1690Z353N1695Z353N1695Z353N1692Z351N1697Z351N1697Z351N1697Z348N1700Z348N1700Z346N1702Z346N1702Z346N1699Z346N1702Z346N1702Z341N1707Z341N1707Z341N1707Z336N1712Z336N1710Z333N1715Z333N1715Z333N1715Z330N1718Z330N1718Z330N1173Z10N535Z325N1178Z10N535Z325N1167Z26N527Z325N1170Z26N527Z325N1170Z26N527Z325N1168Z33N522Z315N1178Z33N522Z315N1175Z41N520Z297N1190Z41N520Z297N1190Z41N520Z297N1190Z46N517Z290N1195Z46N517Z290N1193Z53N515Z282N1198Z53N515Z282N1198Z53N515Z282N1195Z59N515Z273N1201Z59N515Z273N1201Z64N515Z263N1206Z64N515Z263N1206Z64N515Z263N1204Z69N519Z251N1209Z69N519Z251N1209Z69N519Z251N1206Z74N525Z241N1208Z74N525Z241N1205Z80N525Z230N1213Z80N525Z230N1213Z80N525Z230N1213Z77N530Z218N1223Z77N530Z218N1223Z75N532Z210N1231Z75N532Z210N1231Z75N532Z210N1231Z72N535Z205N1236Z72N535Z205N1236Z72N535Z200N1241Z72N535Z200N1241Z72N535Z200N1241Z70N537Z195N1246Z70N537Z195N1246Z64N543Z190N1251Z64N543Z190N1251Z64N543Z190N1251Z59N548Z184N1257Z59N548Z184N1257Z59N548Z184N1260Z61N543Z179N1265Z61N543Z179N1270Z69N533Z174N1272Z69N533Z174N1272Z69N533Z174N1277Z77N520Z169N1282Z77N520Z169N1285Z79N515Z166N1288Z79N515Z166N1288Z79N515Z166N1290Z80N512Z164N1292Z80N512Z164N1295Z79N510Z156N1303Z79N510Z156N1303Z79N510Z156N1305Z77N512Z149N1310Z77N512Z149N1310Z77N512Z149N1310Z77N512Z141N1318Z77N512Z141N1318Z77N512Z136N1323Z77N512Z136N1323Z77N512Z136N1323Z75N517Z130N1326Z75N517Z130N1324Z77N519Z126N1326Z77N519Z126N1326Z77N519Z126N1326Z74N522Z123N1329Z74N522Z123N1329Z74N525Z120N1329Z74N525Z120N1329Z74N525Z120N1326Z77N525Z118N1328Z77N525Z118N1328Z75N527Z118N1328Z75N527Z118N1328Z75N527Z118N1328Z75N529Z113N1331Z75N529Z113N1331Z75N529Z113N1331Z75N529Z113N1331Z75N529Z113N1329Z77N529Z113N1329Z77N529Z113N1329Z77N529Z113N1326Z80N529Z113N1326Z80N529Z113N1326Z77N532Z113N1326Z77N532Z113N1326Z77N532Z113N1324Z79N532Z113N1324Z79N532Z113N1324Z79N535Z110N1324Z79N535Z110N1324Z79N535Z110N1324Z79N535Z110N1324Z79N535Z110N1321Z82N535Z110N1321Z82N535Z110N1321Z82N535Z110N1321Z82N535Z110N1321Z82N535Z110N1321Z82N535Z110N1321Z79N541Z105N1323Z79N541Z105N1323Z79N541Z105N1323Z79N541Z105N1323Z79N541Z105N1323Z77N545Z100N1326Z77N545Z100N1326Z74N553Z95N1326Z74N553Z95N1326Z74N553Z95N1326Z72N558Z89N1329Z72N558Z89N1329Z69N566Z84N1329Z69N566Z84N1329Z69N566Z84N1329Z67N571Z79N1331Z67N571Z79N1331Z67N571Z79N1331Z64N576Z77N1331Z64N576Z77N1331Z64N581Z69N1334Z64N581Z69N1334Z64N581Z69N1334Z64N586Z59N1339Z64N586Z59N1339Z64N591Z52N1341Z64N591Z52N1341Z64N591Z52N1341Z62N596Z44N1346Z62N596Z44N1346Z62N601Z33N1352Z62N601Z33N1352Z62N601Z33N1352Z62N606Z26N1354Z62N606Z26N1354Z62N611Z16N1359Z62N611Z16N1359Z62N611Z16N1359Z59N619Z8N1362Z59N619Z8N1362Z59N619Z8N1365Z56N1992Z56N1994Z51N1997Z51N1997Z51N2000Z43N2005Z43N2010Z33N2015Z33N2015Z33N2020Z23N2025Z23N2028Z15N2033Z15N2033Z15N2035Z10N2038Z10N2041Z5N2043Z5N2043Z5N519175Z",
    "num_predicted_pixels": 89771,
    "percentage_predicted_pixels": 0.021403074264526367,
    "mask_shape": (2048, 2048),
}
_EXPECTED_VP_PREDS = [
    {
        "label_name": "Green Field",
        "label_index": 3,
        "score": 0.7942148303894712,
        "encoded_mask": "255Z52N14Z34N10Z18N120Z18N49Z10N829Z4N445Z52N14Z34N10Z18N120Z18N49Z10N829Z4N445Z52N14Z34N10Z18N120Z18N49Z10N829Z4N445Z52N14Z34N10Z18N120Z18N49Z10N829Z4N445Z52N14Z34N10Z18N120Z18N49Z10N829Z4N445Z52N14Z34N10Z18N120Z18N49Z10N829Z4N445Z52N14Z34N10Z18N120Z18N49Z10N829Z4N445Z52N14Z34N10Z18N120Z18N49Z10N829Z4N445Z50N20Z26N16Z14N191Z6N831Z2N447Z50N20Z26N16Z14N191Z6N831Z2N447Z46N74Z2N1030Z2N449Z46N74Z2N1030Z2N449Z42N1561Z42N1561Z38N1565Z38N1565Z36N1567Z36N1567Z34N1569Z34N1569Z32N339Z6N1226Z32N339Z6N1226Z30N339Z12N1222Z30N339Z12N1222Z30N339Z12N1222Z30N339Z12N1224Z28N341Z10N1224Z30N339Z10N1224Z30N339Z10N1224Z30N341Z8N1224Z30N341Z8N1226Z30N341Z6N340Z12N874Z30N341Z6N340Z12N874Z30N341Z6N336Z18N872Z30N341Z6N336Z18N872Z30N343Z2N336Z22N870Z30N343Z2N336Z22N872Z28N681Z24N870Z28N681Z24N870Z28N681Z26N868Z28N681Z26N868Z28N681Z26N868Z28N681Z26N870Z26N681Z28N868Z26N681Z28N868Z26N683Z28N866Z26N683Z28N868Z22N685Z28N868Z22N685Z28N868Z22N685Z30N866Z22N685Z30N868Z18N687Z32N868Z16N687Z32N868Z16N687Z32N868Z14N689Z32N868Z14N689Z32N872Z10N689Z32N872Z10N689Z32N876Z4N691Z32N876Z4N691Z32N1573Z30N1573Z30N1573Z30N1573Z30N1575Z26N1577Z26N1579Z24N1579Z24N1581Z20N1583Z20N1587Z10N1593Z10N49086Z18N1585Z18N1577Z32N1571Z32N1565Z42N1561Z42N1559Z48N1555Z48N1551Z54N195Z4N1350Z54N195Z4N1350Z54N193Z6N1350Z54N193Z6N1350Z56N189Z8N1350Z56N189Z8N1348Z56N195Z2N1350Z56N195Z2N1352Z52N1551Z52N1551Z48N1555Z48N1555Z44N1559Z44N1559Z40N1563Z40N1565Z34N1569Z32N86Z2N976Z6N501Z32N86Z2N976Z6N501Z30N1066Z14N493Z30N1066Z14N495Z26N1068Z12N497Z26N1068Z12N499Z22N1581Z22N1583Z14N1589Z14N28838Z24N1579Z24N1577Z30N1573Z30N1513Z4N54Z36N1509Z4N54Z36N1509Z8N48Z42N1505Z8N48Z42N1505Z14N42Z44N1503Z14N42Z44N1505Z16N38Z42N1507Z16N38Z42N1511Z12N40Z36N1515Z12N40Z36N1521Z6N42Z24N1531Z6N42Z24N1535Z2N46Z10N1545Z2N46Z10N17116Z4N1599Z4N1599Z8N1595Z8N1593Z14N1589Z14N1589Z18N1585Z18N1585Z20N1583Z20N1583Z22N1581Z22N1579Z26N1577Z26N1577Z26N1577Z26N1573Z30N1573Z30N1567Z36N1567Z36N1273Z8N276Z46N1271Z12N270Z50N1271Z12N270Z50N1271Z14N266Z52N1271Z14N266Z52N1269Z18N262Z54N1269Z18N262Z54N1269Z18N264Z52N1269Z18N264Z52N1271Z14N268Z48N1273Z14N268Z48N1273Z12N272Z46N1273Z12N272Z46N1275Z6N278Z42N1277Z6N278Z42N1561Z32N6Z2N108Z8N1447Z32N6Z2N108Z8N1449Z26N118Z10N1449Z26N118Z10N1455Z16N120Z12N1455Z16N120Z12N1463Z6N120Z14N1463Z6N120Z23N1580Z23N1580Z14N1593Z10N1593Z10N12462Z6N1597Z6N1595Z8N1595Z8N1595Z10N1593Z10N1595Z6N1597Z6N1599Z4N1599Z4N59481Z4N1599Z4N1599Z4N1599Z4N80918Z2N1601Z2N1599Z12N1591Z12N1589Z18N1585Z18N1583Z24N1579Z24N1577Z28N1575Z28N1575Z30N1573Z30N1571Z32N1571Z32N1571Z30N1573Z30N1571Z32N1571Z32N1569Z32N1569Z32N1571Z32N1567Z36N1567Z36N1565Z36N1567Z36N1565Z36N1567Z36N1565Z36N1567Z36N1567Z34N1569Z34N1569Z32N1571Z32N1571Z30N1573Z30N1577Z22N1581Z22N1587Z4N1599Z4N5570Z6N1597Z6N1599Z6N1597Z6N1597Z6N1599Z6N1597Z6N1603Z2N1601Z2N1603Z6N1597Z6N1599Z10N1593Z10N1595Z16N1587Z16N1589Z20N1583Z20N1583Z22N1581Z22N1581Z24N1579Z24N1579Z26N1577Z26N1577Z30N1573Z30N1573Z56N1547Z56N1547Z12N10Z40N1541Z10N14Z42N1537Z10N14Z42N1537Z8N18Z42N1535Z8N18Z42N1533Z12N16Z42N1533Z12N16Z42N1531Z18N10Z44N1531Z18N10Z44N1533Z18N4Z48N1533Z18N4Z48N1535Z68N1535Z68N1537Z66N1537Z66N1543Z60N1543Z60N1547Z54N1549Z54N1553Z50N1553Z50N1559Z18N1585Z18N432315Z8N1595Z8N1595Z10N1593Z10N1591Z12N1591Z12N1593Z10N1593Z10N1595Z8N1595Z8N90427Z2N1601Z2N1601Z2N1601Z2N1601Z2N1601Z2N1599Z2N1601Z2N177280Z8N1595Z8N1591Z14N1589Z14N1587Z16N1587Z16N1587Z18N1587Z14N1589Z14N1595Z8N1595Z8N14726Z8N1595Z8N1593Z12N1591Z12N1591Z14N1589Z14N1589Z16N1587Z16N1587Z18N1585Z18N1587Z22N1581Z22N1581Z24N1581Z24N1579Z24N1581Z24N1579Z24N1581Z22N1581Z22N1583Z22N1581Z22N1583Z18N1585Z18N1587Z16N1587Z16N1589Z12N1591Z12N1593Z10N1593Z10N1595Z6N1597Z6N65833Z8N1595Z8N1593Z12N1591Z12N1591Z14N1589Z14N1587Z18N1585Z18N1585Z20N1583Z20N1583Z20N1583Z20N1587Z16N1587Z16N1593Z10N1593Z10N1597Z6N162091Z4N1599Z4N1591Z50N1553Z50N1551Z52N1551Z52N1549Z54N1549Z54N1549Z54N1549Z54N1551Z52N1551Z52N1551Z52N1551Z52N1551Z52N1551Z52N1553Z50N1553Z50N1553Z50N1553Z50N1555Z48N1555Z48N1557Z46N1557Z46N1559Z44N1559Z44N1561Z42N1565Z38N1565Z38N1569Z34N1569Z34N1571Z32N1571Z32N1571Z32N1571Z32N1573Z30N1573Z30N1573Z30N1573Z30N1575Z28N1575Z28N1575Z28N1575Z28N1577Z26N1577Z26N1577Z26N1577Z26N1577Z26N1577Z26N1577Z26N1577Z26N1579Z24N1579Z24N1579Z24N1579Z24N1579Z24N1579Z24N1579Z24N1579Z24N1579Z24N1363Z4N214Z22N1363Z4N214Z22N1363Z4N214Z22N1363Z4N214Z22N1363Z4N216Z20N1363Z4N216Z20N1363Z4N220Z16N1363Z4N220Z16N1363Z4N224Z12N1363Z4N224Z12N1363Z4N1599Z4N1599Z4N1599Z4N1601Z4N1599Z4N1599Z4N1599Z2N1601Z2N40877Z28N1575Z28N1573Z36N1567Z36N1565Z38N1565Z38N1565Z36N1567Z36N1567Z32N1571Z32N1571Z28N1575Z28N1575Z24N1579Z24N1579Z18N1585Z18N1220Z12N355Z10N1226Z12N355Z10N1198Z4N20Z20N1559Z4N20Z20N1561Z4N16Z22N343Z6N1212Z4N16Z22N343Z6N1232Z20N341Z14N1230Z18N339Z16N1230Z18N339Z16N1230Z16N339Z20N1228Z16N339Z20N1230Z12N339Z22N82Z2N1146Z12N339Z22N82Z2N1148Z8N339Z24N80Z6N1146Z8N339Z24N80Z6N1493Z24N80Z12N1487Z24N80Z12N1485Z28N76Z22N1477Z28N76Z22N1477Z26N78Z24N1475Z26N78Z24N1475Z26N80Z24N1473Z26N80Z24N1473Z24N82Z24N1473Z24N82Z24N1473Z24N18Z8N58Z22N1473Z24N18Z8N58Z22N1473Z22N18Z14N54Z22N1473Z22N18Z14N54Z22N1473Z22N18Z16N56Z20N1471Z22N18Z16N56Z20N1471Z22N18Z18N56Z18N966Z4N501Z20N20Z20N54Z18N966Z4N501Z20N20Z20N54Z18N964Z8N220Z4N275Z20N18Z22N58Z12N966Z8N220Z4N275Z20N18Z22N58Z12N970Z2N222Z4N275Z20N18Z20N1042Z2N222Z4N275Z20N18Z20N1266Z4N275Z18N20Z20N1266Z4N275Z18N20Z20N1266Z6N275Z16N18Z20N1268Z6N275Z16N18Z20N1268Z6N279Z10N20Z20N1268Z6N279Z10N20Z20N1266Z8N309Z20N322Z4N940Z8N309Z20N322Z4N940Z8N307Z22N322Z4N940Z8N307Z22N322Z4N940Z8N307Z20N322Z8N938Z8N307Z20N322Z8N938Z8N307Z20N322Z8N938Z8N307Z20N322Z8N940Z6N309Z16N324Z6N942Z6N309Z16N324Z6N942Z4N311Z14N328Z4N942Z4N311Z14N328Z4N942Z4N313Z10N330Z4N1263Z4N1599Z4N23976Z25N1578Z25N1574Z31N232Z2N1338Z31N232Z2N1336Z35N228Z8N1332Z35N228Z8N1068Z2N270Z27N226Z14N1064Z2N270Z27N226Z14N1064Z2N287Z12N224Z14N1589Z12N1591Z12N1591Z10N1593Z10N1595Z6N1597Z6N1597Z4N1599Z4N1599Z4N1599Z4N178682Z14N1589Z14N1587Z22N1581Z22N1585Z18N1585Z18N1593Z10N1597Z6N1597Z6N1599Z2N1601Z2N1601Z2N1601Z2N190813Z",
        "mask_shape": (1539, 1603),
        "num_predicted_pixels": 17314,
        "percentage_predicted_pixels": 0.007018192416185215,
    },
    {
        "label_name": "Brown Field",
        "label_index": 4,
        "score": 0.9098416565782786,
        "mask_shape": (1539, 1603),
        "num_predicted_pixels": 596064,
        "percentage_predicted_pixels": 0.24161325195570196,
    },
    {
        "label_name": "Trees",
        "label_index": 5,
        "score": 0.9710712753700526,
        "mask_shape": (1539, 1603),
        "num_predicted_pixels": 994139,
        "percentage_predicted_pixels": 0.40297209139620843,
    },
    {
        "label_name": "Structure",
        "label_index": 6,
        "score": 0.9554906769429725,
        "mask_shape": (1539, 1603),
        "num_predicted_pixels": 841192,
        "percentage_predicted_pixels": 0.340975356067672,
    },
]


def test_od_predict():
    Path("tests/output").mkdir(parents=True, exist_ok=True)
    # Endpoint: https://app.landing.ai/app/376/pr/11165/deployment?device=tiger-team-integration-tests
    endpoint_id = "db90b68d-cbfd-4a9c-8dc2-ebc4c3f6e5a4"
    predictor = Predictor(endpoint_id, _API_KEY, _API_SECRET)
    img = np.asarray(Image.open("tests/data/images/cereal1.jpeg"))
    assert img is not None
    # Call LandingLens inference endpoint with Predictor.predict()
    preds = predictor.predict(img)
    assert len(preds) == 3, "Result should not be empty or None"
    expected_scores = [0.9998756647109985, 0.9975845217704773, 0.9853843450546265]
    expected_bboxes = [
        (1505, 1416, 2038, 1823),
        (437, 1034, 642, 1212),
        (951, 1585, 1119, 1783),
    ]
    for i, pred in enumerate(preds):
        assert pred.label_name == "Screw"
        assert pred.label_index == 1
        assert pred.score == expected_scores[i]
        assert pred.bboxes == expected_bboxes[i]
    logging.info(preds)
    img_with_preds = overlay_predictions(predictions=preds, image=img)
    img_with_preds.save("tests/output/test_od.jpg")


def test_seg_predict():
    Path("tests/output").mkdir(parents=True, exist_ok=True)
    # Project: https://app.landing.ai/app/376/pr/26113016987660/deployment?device=tiger-team-integration-tests
    endpoint_id = "72fdc6c2-20f1-4f5e-8df4-62387acec6e4"
    predictor = Predictor(endpoint_id, _API_KEY, _API_SECRET)
    img = np.asarray(Image.open("tests/data/images/cereal1.jpeg"))
    assert img is not None
    preds = predictor.predict(img)
    assert len(preds) == 1, "Result should not be empty or None"
    _assert_seg_mask(preds[0], _EXPECTED_SEG_PRED)
    logging.info(preds)
    img_with_masks = overlay_predictions(preds, img)
    img_with_masks.save("tests/output/test_seg.jpg")


def test_vp_predict():
    Path("tests/output").mkdir(parents=True, exist_ok=True)
    # Project: https://app.landing.ai/app/376/pr/26098103179275/deployment?device=tiger-example
    endpoint_id = "63035608-9d24-4342-8042-e4b08e084fde"
    predictor = Predictor(endpoint_id, _API_KEY, _API_SECRET)
    img = np.asarray(Image.open("tests/data/images/farm-coverage.jpg"))
    assert img is not None
    preds = predictor.predict(img)
    assert len(preds) == 4, "Result should not be empty or None"
    for actual, expected in zip(preds, _EXPECTED_VP_PREDS):
        _assert_seg_mask(actual, expected)
    logging.info(preds)
    img_with_masks = overlay_predictions(preds, img)
    img_with_masks.save("tests/output/test_vp.jpg")


def test_class_predict():
    Path("tests/output").mkdir(parents=True, exist_ok=True)
    # Project: https://app.landing.ai/app/376/pr/26119078438913/deployment?device=tiger-team-integration-tests
    endpoint_id = "8fc1bc53-c5c1-4154-8cc1-a08f2e17ba43"
    predictor = Predictor(endpoint_id, _API_KEY, _API_SECRET)
    img = np.asarray(Image.open("tests/data/images/wildfire1.jpeg"))
    assert img is not None
    preds = predictor.predict(img)
    assert len(preds) == 1, "Result should not be empty or None"
    assert preds[0].label_name == "HasFire"
    assert preds[0].label_index == 0
    assert preds[0].score == 0.99280846118927
    logging.info(preds)
    img_with_masks = overlay_predictions(preds, img)
    img_with_masks.save("tests/output/test_class.jpg")


def _assert_seg_mask(pred: SegmentationPrediction, expected: dict[str, Any]):
    assert pred.label_name == expected["label_name"]
    assert pred.label_index == expected["label_index"]
    assert pred.score == expected["score"]
    assert pred.num_predicted_pixels == expected["num_predicted_pixels"]
    assert pred.percentage_predicted_pixels == expected["percentage_predicted_pixels"]
    assert pred.decoded_boolean_mask.shape == expected["mask_shape"]
    assert np.unique(pred.decoded_boolean_mask).tolist() == [0, 1]
    assert np.unique(pred.decoded_index_mask).tolist() == [0, pred.label_index]
    if "encoded_mask" in expected:
        assert pred.encoded_mask == expected["encoded_mask"]
