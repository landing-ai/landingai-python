# Auto generated by infra-cli. Version: v2.0.3

# NOTE
# 1. This script downloads ocr streamlit app's image from ECR and deploys to EKS cluster staging and production account with Helm.
# 2. The pipeline and codebuild running this are in dev2 edgelicenseserver-app-pieline.
# 3. It always deploys the latest image for now.
version: 0.2

phases:
  install:
    runtime-versions:
      python: 3.9
    commands:
      - apt-get update && apt-get install -y sudo git awscli
      - wget --no-verbose https://landing-resources.s3-us-east-2.amazonaws.com/xa/xa_0.0.3_linux_amd64.deb && dpkg -i ./xa_0.0.3_linux_amd64.deb
      - git clone https://${GITHUB_TOKEN}@github.com/landing-ai/infra-cli.git
      - cd infra-cli
      - INFRACLI_INSTALL_LIGHT=1 bash ./install.sh
      - cd ..
      - DEV_ACCOUNT=$(aws sts get-caller-identity | jq -r '.Account')
      - aws ecr get-login-password | docker login --username AWS --password-stdin $DEV_ACCOUNT.dkr.ecr.us-east-2.amazonaws.com
  pre_build:
    commands:
      - export XA_ENVIRONMENT=${XA_ENVIRONMENT:-$XA_ENV}
      - echo "Getting cross account identity for $XA_ENVIRONMENT"
      - $(xa)
      - export XA_ACCOUNT_ID=$(aws sts get-caller-identity | jq -rc '.Account')
      - infra-cli connect-aws $XA_ACCOUNT_ID $AWS_REGION $CLUSTER_NAME
  build:
    commands:
      # make sure the cluster has pull permissions for the image
      - COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)
      - echo "Deploying to k8s cluster $CLUSTER_NAME..."
      - echo "Deploying helm charts edgelicenseserver-app to '$TIER'" ...
      - cd examples/apps/ocr 
      - infra-cli gen-st-app lappocr
      - cd /tmp/infra-cli-st/apprepo/lappocr/
      - infra-cli deploy-lnd-app --tier $TIER --image-tag $COMMIT_HASH

artifacts:
  files:
    - "**/*"
cache:
  paths: []

