# Auto generated by infra-cli. Version: v2.0.3

# NOTE
# 1. This script builds ocr streamlit app's source code into image and push into ECR.
# 2. Code build is trigged when a new commit is merged into the main branch, i.e. a PR.
# 3. ECR will apply scan-on-push strategy on every new image.
# 4. Each image has two tags, 1) one commit hash tag 2) latest tag; we will use latest as the default tag.
version: 0.2

phases:
  install:
    runtime-versions:
      python: 3.7
    commands:
      - apt-get update && apt-get install -y sudo git awscli
      - wget --no-verbose https://landing-resources.s3-us-east-2.amazonaws.com/xa/xa_0.0.3_linux_amd64.deb && dpkg -i ./xa_0.0.3_linux_amd64.deb
      - git clone https://${GITHUB_TOKEN}@github.com/landing-ai/infra-cli.git
      - cd infra-cli
      - INFRACLI_INSTALL_LIGHT=1 bash ./install.sh
      - cd ..
  pre_build:
    commands:
      - export XA_ENVIRONMENT=${XA_ENVIRONMENT:-$XA_ENV}
      - echo "Getting cross account identity for $XA_ENVIRONMENT"
      - $(xa)
      - export XA_ACCOUNT_ID=$(aws sts get-caller-identity | jq -rc '.Account')
      - infra-cli connect-aws $XA_ACCOUNT_ID $AWS_REGION $CLUSTER_NAME
  build:
    commands:
      - COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)
      - IMAGE_TAG=${COMMIT_HASH:=latest}
      - cd examples/apps/ocr
      - infra-cli gen-st-app lappocr
      - cd /tmp/infra-cli-st/apprepo/lappocr/
      - infra-cli build-lnd-app --tag $IMAGE_TAG
artifacts:
  files:
    - "**/*"
cache:
  paths: []

